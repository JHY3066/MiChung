"""
v8: v7 ë¡œì§ + v5ì˜ ì´ì¤‘ í•„í„° ì ìš©
- v7 (ê¸€ë¡œë²Œ RF ëª¨ë¸, v3 íŠ¹ì„± ê³µí•™)ì„ ê¸°ë°˜
- v5ì˜ ì´ì¤‘ í•„í„°(CCF + Pearson) ë¡œì§ì„ Step 2ì— ê²°í•©
- ì„ê³„ê°’: CCF > 0.30 AND Lagged Pearson > 0.30
- ëª¨ë¸: ë‹¨ì¼ ê¸€ë¡œë²Œ RandomForest
- [Fix]: .itertuples()ë¥¼ .iterrows()ë¡œ ë³€ê²½í•˜ì—¬ AttributeError í•´ê²°
"""

import pandas as pd
import numpy as np
from sklearn.ensemble import RandomForestRegressor
# [ì¶”ê°€] CCF ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸
from statsmodels.tsa.stattools import ccf
from tqdm import tqdm
import warnings
warnings.filterwarnings('ignore')

print("=" * 80)
print("ğŸš€ v8: v7 ë¡œì§ + ì´ì¤‘ í•„í„°(CCF/Pearson) ì ìš©")
print("=" * 80)

# ============================================================================
# 1. ë°ì´í„° ë¡œë“œ ë° í”¼ë²— í…Œì´ë¸” ìƒì„±
# ============================================================================
print("\n[1ë‹¨ê³„] ë°ì´í„° ë¡œë“œ ì¤‘...")
try:
    train = pd.read_csv("/content/train.csv")
    submission_df = pd.read_csv("/content/sample_submission.csv")
except FileNotFoundError:
    print("ì˜¤ë¥˜: train.csv ë˜ëŠ” sample_submission.csv íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    exit()

train['ym'] = pd.to_datetime(train['year'].astype(str) + '-' + train['month'].astype(str) + '-01')

# Pivot í…Œì´ë¸” ìƒì„± (v3 Lagged Pearson ìš©)
pivot = train.groupby(['item_id', 'ym'])['value'].sum().unstack(fill_value=0)
# [ì¶”ê°€] ì°¨ë¶„(Diff) Pivot í…Œì´ë¸” ìƒì„± (v5 CCF ìš©)
pivot_diff = pivot.diff(axis=1).fillna(0)

print(f"Pivot shape: {pivot.shape}")

# ============================================================================
# 2. ê³µí–‰ì„± ìŒ íƒìƒ‰ (v5 + v7 ì´ì¤‘ í•„í„° ë¡œì§ ì ìš©)
# ============================================================================
print("\n[2ë‹¨ê³„] ê³µí–‰ì„± ìŒ íƒìƒ‰ ì¤‘ (ì´ì¤‘ í•„í„°, CCF 0.30 + Pearson 0.30)...")

# v3/v7ì˜ Lagged Pearson í•¨ìˆ˜
def find_best_lag_corr_pearson(a_series_val, b_series_val, max_lag=12):
    best_corr = -1
    best_lag = 0
    for lag in range(max_lag + 1): # 0~12
        if lag >= len(a_series_val): break
        a_lagged = a_series_val[:-lag-1] if lag > 0 else a_series_val[:-1]
        b_target = b_series_val[lag+1:]
        if len(a_lagged) != len(b_target) or len(a_lagged) < 2: continue
        corr = np.corrcoef(a_lagged, b_target)[0, 1]
        if not np.isnan(corr) and corr > best_corr:
            best_corr = corr
            best_lag = lag
    return best_corr, best_lag

# v5ì˜ CCF í•¨ìˆ˜ (ìµœëŒ€ê°’ ì°¾ê¸°)
def find_max_corr_ccf(a_series_diff_val, b_series_diff_val, max_lag=12):
    # CCFëŠ” lag 0 (ë™ì‹œ)ë¥¼ ì œì™¸í•˜ê³  1~max_lagì—ì„œ ì°¾ëŠ” ê²ƒì´ ì¼ë°˜ì 
    if len(a_series_diff_val) < max_lag + 2 or len(b_series_diff_val) < max_lag + 2:
        return 0.0 # ë°ì´í„°ê°€ ë„ˆë¬´ ì§§ìœ¼ë©´ 0

    correlations = ccf(a_series_diff_val, b_series_diff_val, adjusted=False, nlags=max_lag)
    # lag 0 (ë™ì‹œ) ì œì™¸, 1~max_lag ì¤‘ ìµœëŒ€ê°’
    max_corr_ccf = np.max(np.abs(correlations[1:max_lag+1]))
    if np.isnan(max_corr_ccf):
        return 0.0
    return max_corr_ccf

# submission_dfì˜ ëª¨ë“  ìŒì— ëŒ€í•´ *ë‘ ê°œì˜* ìƒê´€ê³„ìˆ˜ë¥¼ ëª¨ë‘ ê³„ì‚°
pairs = []
# [ìˆ˜ì •] itertuples() ëŒ€ì‹  iterrows()ë¥¼ ì‚¬ìš©í•˜ì—¬ ì•ˆì •ì„± í™•ë³´
for index, row in tqdm(submission_df.iterrows(), total=len(submission_df), desc="ìŒ ê´€ê³„ íƒìƒ‰ (ì´ì¤‘ í•„í„°)"):
    # [ìˆ˜ì •] . (ì ) ì ‘ê·¼ ëŒ€ì‹  [] (í‚¤) ì ‘ê·¼ìœ¼ë¡œ ë³€ê²½
    leader = row['leading_item_id']
    follower = row['following_item_id']

    if leader in pivot.index and follower in pivot.index:
        # 1. Lagged Pearson ê³„ì‚° (v7 ë°©ì‹)
        a_series_orig = pivot.loc[leader].values
        b_series_orig = pivot.loc[follower].values
        max_corr_pearson, best_lag = find_best_lag_corr_pearson(a_series_orig, b_series_orig, max_lag=12)

        # 2. CCF ê³„ì‚° (v5 ë°©ì‹)
        a_series_diff = pivot_diff.loc[leader].values
        b_series_diff = pivot_diff.loc[follower].values
        max_corr_ccf = find_max_corr_ccf(a_series_diff, b_series_diff, max_lag=12)

        pairs.append({
            'leading_item_id': leader,
            'following_item_id': follower,
            'max_corr_pearson': max_corr_pearson,
            'max_corr_ccf': max_corr_ccf,
            'best_lag': best_lag # v7ì˜ pearson lagë¥¼ ë”°ë¦„
        })

pairs_df = pd.DataFrame(pairs)

# [ìˆ˜ì •] ì´ì¤‘ í•„í„° ì„ê³„ê°’
CORR_THRESHOLD_PEARSON = 0.30
CORR_THRESHOLD_CCF = 0.30

filtered_pairs = pairs_df[
    (pairs_df['max_corr_pearson'] >= CORR_THRESHOLD_PEARSON) &
    (pairs_df['max_corr_ccf'] >= CORR_THRESHOLD_CCF)
].copy()

# 'max_corr' ì»¬ëŸ¼ì„ v3 ë¡œì§(Pearson) ê¸°ì¤€ìœ¼ë¡œ ë‹¤ì‹œ ìƒì„± (í•™ìŠµ íŠ¹ì„±ìœ¼ë¡œ ì‚¬ìš©)
filtered_pairs['max_corr'] = filtered_pairs['max_corr_pearson']

print(f"\nâœ… íƒìƒ‰ëœ ê³µí–‰ì„± ìŒ ìˆ˜ (ì´ì¤‘ í•„í„° í†µê³¼): {len(filtered_pairs)}")
if len(filtered_pairs) > 0:
    print(f"Pearson ìƒê´€ê³„ìˆ˜ ë²”ìœ„: {filtered_pairs['max_corr_pearson'].min():.3f} ~ {filtered_pairs['max_corr_pearson'].max():.3f}")
    print(f"CCF ìƒê´€ê³„ìˆ˜ ë²”ìœ„: {filtered_pairs['max_corr_ccf'].min():.3f} ~ {filtered_pairs['max_corr_ccf'].max():.3f}")
else:
    print("ê²½ê³ : ì´ì¤‘ í•„í„°ë¥¼ í†µê³¼í•˜ëŠ” ìŒì´ ì—†ìŠµë‹ˆë‹¤. ì„ê³„ê°’ì„ ë‚®ì¶°ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")


# ============================================================================
# 3. Feature Engineering (v7(v3)ì™€ ë™ì¼)
# ============================================================================
print("\n[3ë‹¨ê³„] Feature Engineering ì¤‘...")

def create_features_v3(pivot_table, pairs_to_train):
    """
    v3ì™€ ë™ì¼í•œ ê³ ê¸‰ Feature ìƒì„± í•¨ìˆ˜
    """
    months = pivot_table.columns.to_list()
    n_months = len(months)
    train_data = []

    # [ìˆ˜ì •] .itertuples() -> .iterrows()
    for index, row in tqdm(pairs_to_train.iterrows(), total=len(pairs_to_train), desc="Feature ìƒì„±"):
        # [ìˆ˜ì •] . -> []
        leader = row['leading_item_id']
        follower = row['following_item_id']
        lag = int(row['best_lag'])
        corr = float(row['max_corr']) # Lagged Pearson ê°’

        a_series = pivot_table.loc[leader].values.astype(float)
        b_series = pivot_table.loc[follower].values.astype(float)

        for t in range(lag + 6, n_months - 1): # ì¶©ë¶„í•œ ê³¼ê±° ë°ì´í„° í™•ë³´
            # ê¸°ë³¸ features
            b_t = b_series[t]
            b_t_1 = b_series[t - 1]
            a_t_lag = a_series[t - lag]

            # [ìˆ˜ì •] Targetì— np.log1p(ë¡œê·¸ ë³€í™˜) ì ìš©
            target_raw = b_series[t + 1]
            target = np.log1p(target_raw)

            # Lag features
            a_lag1 = a_series[t - 1] if t >= 1 else 0
            a_lag2 = a_series[t - 2] if t >= 2 else 0
            a_lag3 = a_series[t - 3] if t >= 3 else 0
            b_lag2 = b_series[t - 2] if t >= 2 else 0
            b_lag3 = b_series[t - 3] if t >= 3 else 0

            # ì´ë™í‰ê·  (3ê°œì›”, 6ê°œì›”)
            b_ma3 = np.mean(b_series[max(0, t-2):t+1]) if t >= 2 else b_t
            b_ma6 = np.mean(b_series[max(0, t-5):t+1]) if t >= 5 else b_t
            a_ma3 = np.mean(a_series[max(0, t-2):t+1]) if t >= 2 else a_t_lag

            # ë³€í™”ìœ¨ (MoM)
            b_mom = (b_t - b_t_1) / (b_t_1 + 1) if b_t_1 > 0 else 0
            a_mom = (a_t_lag - a_lag1) / (a_lag1 + 1) if a_lag1 > 0 else 0

            # ê³„ì ˆì„± (ì›”)
            month = pd.to_datetime(months[t]).month
            is_jan = 1 if month == 1 else 0
            is_sep = 1 if month == 9 else 0

            # íŠ¸ë Œë“œ
            year = pd.to_datetime(months[t]).year
            year_effect = year - 2022

            train_data.append({
                'b_t': b_t, 'b_t_1': b_t_1, 'a_t_lag': a_t_lag,
                'max_corr': corr, 'best_lag': float(lag),
                'a_lag1': a_lag1, 'a_lag2': a_lag2, 'a_lag3': a_lag3,
                'b_lag2': b_lag2, 'b_lag3': b_lag3,
                'b_ma3': b_ma3, 'b_ma6': b_ma6, 'a_ma3': a_ma3,
                'b_mom': b_mom, 'a_mom': a_mom,
                'is_jan': is_jan, 'is_sep': is_sep, 'month': month,
                'year_effect': year_effect,
                'target': target
            })

    return pd.DataFrame(train_data)

if len(filtered_pairs) > 0:
    df_train = create_features_v3(pivot, filtered_pairs)
    print(f"\ní•™ìŠµ ë°ì´í„° shape: {df_train.shape}")
    if df_train.empty:
        print("ê²½ê³ : í•„í„°ëœ ìŒì´ ìˆìœ¼ë‚˜ í•™ìŠµ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ë°ì´í„° ê¸°ê°„ ë¶€ì¡± ë“±)")
        feature_cols = []
    else:
        print(f"Feature ê°œìˆ˜: {len(df_train.columns) - 1}")
        feature_cols = [col for col in df_train.columns if col != 'target']
else:
    df_train = pd.DataFrame()
    feature_cols = []

# ============================================================================
# 4. RandomForest ëª¨ë¸ í•™ìŠµ (v7ê³¼ ë™ì¼)
# ============================================================================
print("\n[4ë‹¨ê³„] RandomForest ëª¨ë¸ í•™ìŠµ ì¤‘...")

if not df_train.empty and feature_cols:
    train_X = df_train[feature_cols].values
    train_y = df_train['target'].values

    model = RandomForestRegressor(
        n_estimators=200,
        max_depth=6,
        min_samples_leaf=20,
        random_state=42,
        n_jobs=-1
    )

    model.fit(train_X, train_y)
    print("âœ… ëª¨ë¸ í•™ìŠµ ì™„ë£Œ!")

    # Feature Importance
    feature_importance = pd.DataFrame({
        'feature': feature_cols,
        'importance': model.feature_importances_
    }).sort_values('importance', ascending=False)

    print(f"\nTop 10 ì¤‘ìš” Features:")
    print(feature_importance.head(10).to_string())
else:
    print("í•™ìŠµ ë°ì´í„°ê°€ ì—†ì–´ ëª¨ë¸ í•™ìŠµì„ ê±´ë„ˆëœë‹ˆë‹¤.")
    model = None # ëª¨ë¸ì´ ì—†ìŒì„ ëª…ì‹œ

# ============================================================================
# 5. ì˜ˆì¸¡ ë° ì œì¶œ íŒŒì¼ ìƒì„± (v7ê³¼ ë™ì¼)
# ============================================================================
print("\n[5ë‹¨ê³„] ì˜ˆì¸¡ ì¤‘...")

def predict_v3(pivot_table, pairs_to_predict, model_to_use, feature_cols_list):
    """
    v3ì™€ ë™ì¼í•œ ì˜ˆì¸¡ í•¨ìˆ˜ (ëª¨ë¸ ì¢…ë¥˜ì™€ ë¬´ê´€í•˜ê²Œ ì‘ë™)
    """
    months = pivot_table.columns.to_list()
    n_months = len(months)
    t_last = n_months - 1
    t_prev = n_months - 2

    preds = {} # ë”•ì…”ë„ˆë¦¬ë¡œ ì˜ˆì¸¡ê°’ ì €ì¥ (ë¹ ë¥¸ ì¡°íšŒë¥¼ ìœ„í•´)

    # [ìˆ˜ì •] .itertuples() -> .iterrows()
    for index, row in tqdm(pairs_to_predict.iterrows(), total=len(pairs_to_predict), desc="ì˜ˆì¸¡ ì¤‘"):
        # [ìˆ˜ì •] . -> []
        leader = row['leading_item_id']
        follower = row['following_item_id']
        lag = int(row['best_lag'])
        corr = float(row['max_corr']) # Lagged Pearson ê°’

        if leader not in pivot_table.index or follower not in pivot_table.index:
            continue

        a_series = pivot_table.loc[leader].values.astype(float)
        b_series = pivot_table.loc[follower].values.astype(float)

        if t_last - lag < 0:
            continue

        # v3ì™€ ë™ì¼í•œ ì˜ˆì¸¡ìš© íŠ¹ì„± ìƒì„±
        b_t = b_series[t_last]
        b_t_1 = b_series[t_prev]
        a_t_lag = a_series[t_last - lag]

        a_lag1 = a_series[t_last - 1]
        a_lag2 = a_series[t_last - 2] if t_last >= 2 else 0
        a_lag3 = a_series[t_last - 3] if t_last >= 3 else 0
        b_lag2 = b_series[t_last - 2] if t_last >= 2 else 0
        b_lag3 = b_series[t_last - 3] if t_last >= 3 else 0

        b_ma3 = np.mean(b_series[max(0, t_last-2):t_last+1])
        b_ma6 = np.mean(b_series[max(0, t_last-5):t_last+1])
        a_ma3 = np.mean(a_series[max(0, t_last-2):t_last+1])

        b_mom = (b_t - b_t_1) / (b_t_1 + 1) if b_t_1 > 0 else 0
        a_mom = (a_t_lag - a_lag1) / (a_lag1 + 1) if a_lag1 > 0 else 0

        month = 8 # 2025ë…„ 8ì›” ì˜ˆì¸¡
        is_jan = 0
        is_sep = 0
        year_effect = 2025 - 2022

        features = {
            'b_t': b_t, 'b_t_1': b_t_1, 'a_t_lag': a_t_lag,
            'max_corr': corr, 'best_lag': float(lag),
            'a_lag1': a_lag1, 'a_lag2': a_lag2, 'a_lag3': a_lag3,
            'b_lag2': b_lag2, 'b_lag3': b_lag3,
            'b_ma3': b_ma3, 'b_ma6': b_ma6, 'a_ma3': a_ma3,
            'b_mom': b_mom, 'a_mom': a_mom,
            'is_jan': is_jan, 'is_sep': is_sep, 'month': month,
            'year_effect': year_effect
        }

        X_test = np.array([[features[col] for col in feature_cols_list]])

        # [ìˆ˜ì •] ëª¨ë¸ì€ ë¡œê·¸ ê°’ì„ ì˜ˆì¸¡ (y_pred_log)
        y_pred_log = model_to_use.predict(X_test)[0]

        # [ìˆ˜ì •] np.expm1(ì§€ìˆ˜ ë³€í™˜)ì„ ì‚¬ìš©í•´ ì›ë˜ ìŠ¤ì¼€ì¼ë¡œ ë³µì›
        y_pred = np.expm1(y_pred_log)

        y_pred = max(0.0, float(y_pred))
        y_pred = int(round(y_pred))

        # (leader, follower) íŠœí”Œì„ í‚¤ë¡œ ì‚¬ìš©
        preds[(leader, follower)] = y_pred

    return preds

# í•™ìŠµëœ ëª¨ë¸ê³¼ í•„í„°ëœ ìŒìœ¼ë¡œ ì˜ˆì¸¡ ì‹¤í–‰
if model and not filtered_pairs.empty:
    predictions_dict = predict_v3(pivot, filtered_pairs, model, feature_cols)
    print(f"\nâœ… ì˜ˆì¸¡ ì™„ë£Œ! {len(predictions_dict)}ê°œì˜ ìŒì„ ì˜ˆì¸¡í–ˆìŠµë‹ˆë‹¤.")
else:
    print("í•™ìŠµëœ ëª¨ë¸ì´ ì—†ê±°ë‚˜ í•„í„°ëœ ìŒì´ ì—†ì–´ ì˜ˆì¸¡ì„ ê±´ë„ˆëœë‹ˆë‹¤.")
    predictions_dict = {}

# --- ì œì¶œ íŒŒì¼ ìƒì„± ---
# sample_submission.csvì˜ ëª¨ë“  í–‰ì„ ìˆœíšŒí•˜ë©°
# predictions_dictì— ê°’ì´ ìˆìœ¼ë©´ ì±„ìš°ê³ , ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì±„ì›€
final_predictions = []
# [ìˆ˜ì •] submission_df ì›ë³¸ì„ ìˆœíšŒí•´ì•¼ í•¨ (filtered_pairsê°€ ì•„ë‹˜)
# [ìˆ˜ì •] .itertuples() -> .iterrows()
for index, row in tqdm(submission_df.iterrows(), total=len(submission_df), desc="ì œì¶œ íŒŒì¼ ìƒì„±"):
    # [ìˆ˜ì •] . -> []
    key = (row['leading_item_id'], row['following_item_id'])

    # ë”•ì…”ë„ˆë¦¬ì—ì„œ ì˜ˆì¸¡ê°’ ì¡°íšŒ, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 0
    value = predictions_dict.get(key, 0)
    final_predictions.append(value)

submission_df['value'] = final_predictions
# [ìˆ˜ì •] íŒŒì¼ ì´ë¦„ v8ë¡œ ë³€ê²½
output_path = 'submission_v8_rf_dual_filter.csv'
submission_df.to_csv(output_path, index=False)

print(f"\nâœ… ì œì¶œ íŒŒì¼ ì €ì¥: {output_path}")

print("\n" + "=" * 80)
print("v8 (RF + ì´ì¤‘ í•„í„°) ìƒì„± ì™„ë£Œ! ğŸ‰") # [ìˆ˜ì •]
print("=" * 80)
print(f"ì´ {len(submission_df)}ê°œì˜ ìŒ ì¤‘ {len(predictions_dict)}ê°œì˜ ìŒì„ 0ì´ ì•„ë‹Œ ê°’ìœ¼ë¡œ ì˜ˆì¸¡í–ˆìŠµë‹ˆë‹¤.")
print(f"ì˜ˆì¸¡ê°’ í†µê³„ (0 ì œì™¸):")
# 0ìœ¼ë¡œë§Œ ì˜ˆì¸¡ëœ ê²½ìš° describe() ì˜¤ë¥˜ ë°©ì§€
if len(predictions_dict) > 0 and submission_df[submission_df['value'] > 0].empty == False:
    print(submission_df[submission_df['value'] > 0]['value'].describe())
else:
    print("0ë³´ë‹¤ í° ì˜ˆì¸¡ê°’ì´ ì—†ìŠµë‹ˆë‹¤.")
print("=" * 80)
